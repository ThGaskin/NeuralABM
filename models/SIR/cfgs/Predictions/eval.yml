# ======================================================================================================================
#  ╔═╗╦╦═╗  ╔╦╗╔═╗╔╗╔╔═╗╦╔╦╗╦╔═╗╔═╗
#  ╚═╗║╠╦╝   ║║║╣ ║║║╚═╗║ ║ ║║╣ ╚═╗
#  ╚═╝╩╩╚═  ═╩╝╚═╝╝╚╝╚═╝╩ ╩ ╩╚═╝╚═╝
# ======================================================================================================================
# Generate densities by drawing from the joint distribution of the parameters
densities_from_joint:
  based_on:
    - .creator.multiverse
    - .plot.facet_grid.errorbands
  select_and_combine:
    fields:
      parameters:
        path: parameters
        transform: [ .data ]
      probabilities:
        path: loss
        transform: [ neg_exp ]
      true_data:
        path: true_counts
        transform: [.data]
        subspace:
          seed: [ 0 ]
      cfg:
        path: ../../cfg
        transform:
          - getitem: [!dag_prev , 'SIR']
        subspace:
          seed: [0]
  transform:

    # Flatten the cfg
    - .data: [!dag_tag cfg]
    - getitem: [!dag_prev , 0]
      tag: cfg_flattened

    # Flatten the true counts
    - .isel: [!dag_tag true_data, {seed: 0}]
      kwargs: {drop: True}
      tag: true_data_flattened

    # Flatten the probabilities and parameters
    - flatten_dims: [!dag_tag probabilities ]
      kwargs:
        dims: {sample: [batch, seed]}
      tag: prob
    - flatten_dims: [!dag_tag parameters ]
      kwargs:
        dims: {sample: [batch, seed]}
    - .transpose: [!dag_prev ]
      tag: params

    # Get the bins for each parameter
    - xr.DataArray:
        data: [ 100, 100, 100 ]
        dims: [ 'idx' ]

    # Get the joint over the parameters
    - joint_DD: [!dag_tag params, !dag_tag prob, !dag_prev ]
      kwargs:
        normalize: True
        differential: 1
        dim_names: [p_infect, t_infectious, sigma]
      file_cache:
        read: True
        write: True
      tag: joint
    - .fillna: [!dag_prev , 0]
    - SIR_densities_from_joint: [!dag_prev ]
      kwargs:
        true_counts: !dag_tag true_data_flattened
        cfg: !dag_tag cfg_flattened
      file_cache:
        read: True
        write: True
    # No point plotting the mode, as sampling from sigma will produce a single stochastic process, rather than an
    # average
    - .sel: [!dag_prev , {type: [true_counts, prediction_mean]}]
      tag: data
  x: time
  y: mean
  yerr: std
  hue: type
  col: kind
  sharey: False
  add_legend: False
  figsize: [ !dag_result full_width, !dag_result third_width ]
  helpers:
    set_labels:
      y: ' '
    axis_specific:
      0:
        axis: [0, 0]
        set_legend:
          use_legend: True
          gather_from_fig: True
  style:
    axes.prop_cycle: !format
      fstr: "cycler('color', ['{colors[darkblue]:}', '{colors[orange]:}'])"
      colors:
        darkblue: '#2F7194'
        orange: '#EC9F7E'
  file_ext: pdf

# Plot the marginals together
marginals:
  based_on:
    - .creator.multiverse
    - .plot.facet_grid.density
  select_and_combine:
    fields:
      parameters: parameters
      probabilities:
        path: loss
        transform: [neg_exp]
  transform:

    - xr.DataArray:
        data: [[100, 1000], [100, 1000], [100, 1000]]
        dims: ['parameter', 'idx']
        coords: {parameter: ['p_infect', 't_infectious', 'sigma']}
      tag: bins

    # Flatten the prob and parameter samples into a single dimension
    - flatten_dims: [!dag_tag probabilities ]
      kwargs:
        dims: {sample: [batch, seed]}
      tag: prob
    - flatten_dims: [!dag_tag parameters ]
      kwargs:
        dims: {sample: [batch, seed]}
      tag: params
    - broadcast: [!dag_tag params, !dag_tag prob]

    # Get the marginals along the parameters
    - marginal_from_ds: [!dag_prev , !dag_tag bins]
      kwargs:
        x: x
        y: loss
        exclude_dim: [parameter]
      tag: data
  c: !dag_result c_darkblue
  x: x
  y: marginal
  col: parameter
  sharex: False
  sharey: False

# Plot the prior densities on the parameters
priors:
  based_on:
    - .creator.multiverse
    - .plot.multiplot
  select_and_combine:
    fields:
      parameters:
        path: parameters
        transform:
          - .isel: [!dag_prev , {batch: 0}]
  transform:
    - .isel: [!dag_tag parameters, {parameter: 0}]
      tag: p
    - .isel: [!dag_tag parameters, {parameter: 1}]
      tag: t
    - .isel: [!dag_tag parameters, {parameter: 2}]
      tag: sigma
  to_plot:
    [0, 0]:
      - function: sns.histplot
        data: !dag_result p
    [1, 0]:
      - function: sns.histplot
        data: !dag_result t
    [2, 0]:
      - function: sns.histplot
        data: !dag_result sigma
  color: !dag_result c_darkblue
  linewidth: 0.5
  helpers:
    axis_specific:
      0:
        axis: [0, 0]
        set_labels:
          x: $\beta$
      1:
        axis: [ 1, 0 ]
        set_labels:
          x: $\tau$
      2:
        axis: [ 2, 0 ]
        set_labels:
          x: $\sigma$
    setup_figure:
      nrows: 1
      ncols: 3
    set_labels:
      y: ' '
  compute_only: []
  style:
    figure.figsize: [!dag_result full_width, !dag_result quarter_width]

# Plot the predictions over time, colour-coded by loss
predictions:
  based_on:
    - .creator.multiverse
    - .plot.facet_grid.scatter
  select_and_combine:
    fields:
      parameters:
        path: parameters
        transform: [.data]
      loss:
        path: loss
        transform: [.data]
  transform:
    - broadcast: [!dag_tag parameters, !dag_tag loss]
      kwargs:
        exclude_dim: [seed]
    - flatten_dims: [!dag_prev ]
      kwargs:
        dims: {batch: [batch, seed]}
      tag: data
  x: batch
  y: x
  hue: loss
  col: parameter
  s: 2
  sharey: False # Seems to have no effect?
  sharex: False
  helpers:
    set_limits:
      x: [min, max]
      y: [0, max] # Why is this necessary?
  add_legend: False
  norm:
    name: LogNorm
  vmax: 100
  cmap:
    continuous: true
    from_values:
      0: !dag_result c_darkblue
      1: !dag_result c_yellow

# Plot the loss landscape of the parameters, colour-coded by loss
probability_landscape:
  based_on: predictions
  add_legend: False
  select_and_combine:
    fields:
      loss:
        transform:
          - mul: [!dag_prev , -1]
          - np.exp: [!dag_prev ]
  x: x
  y: loss
  hue: loss
  s: 2
  norm: ~
  vmax: ~
  cbar_kwargs:
    label: Unnormalised probability

# Marginal densities on the parameters obtained from the MCMC
marginals:
  based_on:
    - .creator.multiverse
    - .plot.facet_grid.density
  select_and_combine:
    fields:
      parameters: ../langevin_data/parameters
  transform:
    - xr.DataArray:
        data: [1000, 100, 100]
        dims: ['parameter']
        coords: {parameter: ['alpha', 'p_infect', 't_infectious']}
      tag: bins
    - xr.DataArray:
        data: [[0, 1], [0, 1], [1, 30]]
        dims: ['parameter', 'idx']
        coords: {parameter: ['alpha', 'p_infect', 't_infectious']}
      tag: ranges
    - flatten_dims: [!dag_tag parameters ]
      kwargs: {dims: {sample: [seed, sample]}}
    - .rename: [!dag_prev , 'value']
    - to_csv: [!dag_prev , 'data/SIR/MCMC_data.csv']
    - hist_ndim: [!dag_prev , !dag_tag bins , !dag_tag ranges]
      kwargs:
        exclude_dim: [parameter]
        normalize: True
      tag: data
  x: x
  y: value
  col: parameter
  sharex: False
  sharey: False
  c: !dag_result c_darkblue
  smooth_kwargs:
    p_infect:
      enabled: False
    t_infectious:
      enabled: True
      sigma: 2
    alpha:
      enabled: True
      sigma: 100

# Calculate the Gelman-Rubin statistic for each parameter over time
gelman_rubin:
  based_on:
    - .creator.multiverse
    - .plot.facet_grid.line
  select_and_combine:
    fields:
      parameters:
        path: ../langevin_data/parameters
  transform:
    - gelman_rubin: [!dag_tag parameters ]
      kwargs:
        along_dim: [sample, seed]
        step_size: 10
      file_cache:
        read: True
        write: True
    - .to_array: [!dag_prev ]
      tag: data
  x: sample
  col: parameter
  color: !dag_result c_darkgrey
  sharey: False
  helpers:
    set_hv_lines:
      hlines:
        - pos: 1.2
          linestyle: 'dashed'
          color: !dag_result c_red
    setup_figure:
      ncols: 3
      nrows: 1
    axis_specific:
      0:
        axis: [0, 0]
        set_title:
          title: Infection parameter $\beta$
      1:
        axis: [ 1, 0 ]
        set_title:
          title: Recovery parameter $\tau$
      2:
        axis: [ 2, 0 ]
        set_title:
          title: Redundant parameter $\alpha$
  figsize: [ !dag_result full_width, !dag_result third_width ]

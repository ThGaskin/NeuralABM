# ======================================================================================================================
#  ╦  ╦╔═╗╦═╗╦╔═╗╔╗ ╦  ╔═╗╔═╗
#  ╚╗╔╝╠═╣╠╦╝║╠═╣╠╩╗║  ║╣ ╚═╗
#   ╚╝ ╩ ╩╩╚═╩╩ ╩╚═╝╩═╝╚═╝╚═╝
# ======================================================================================================================

.variables:
  colors: &colors
    yellow:         &yellow           '#F5DDA9'
    darkblue:       &darkblue         '#2F7194'
    red:            &red              '#ec7070'
    skyblue:        &skyblue          '#97c3d0'
    darkgreen:      &darkgreen        '#48675A'
    lightbrown:     &lightbrown       '#C6BFA2'
    orange:         &orange           '#EC9F7E'
    lightgreen:     &lightgreen       '#AFD8BC'
    grey:           &grey             '#3D4244'
    pink:           &pink             '#F8A6A6'


  # Page widths in inches for latex documents: ensures easy integration into latex documents
  page_widths:
    full_width:         &full_width         7.5
    half_width:         &half_width         !expr 7.5 / 2
    two_thirds_width:   &two_thirds_width   !expr 2 * 7.5 / 3
    third_width:        &third_width        !expr 7.5 / 3
    quarter_width:      &quarter_width      !expr 7.5 / 4
    fifth_width:        &fifth_width        !expr 7.5 / 5
    eighth_width:       &eighth_width       !expr 7.5 / 8

# ======================================================================================================================
# ╔═╗╦  ╔═╗╔╦╗╔═╗
# ╠═╝║  ║ ║ ║ ╚═╗
# ╩  ╩═╝╚═╝ ╩ ╚═╝
# ======================================================================================================================

# Error over convexity
convexity_error:
  based_on: .errorbands
  dag_options:
    define:
      lower_bin: 0
      upper_bin: 20
      n_bins: 500
  select_and_combine:
    fields:
      N:
        path: ../cfg
        transform:
          - recursive_getitem: [!dag_prev , ['Kuramoto', 'Data', 'synthetic_data', 'N']]
        subspace:
          seed: 0
          training_set_size: 2
      rank: regression_data/rank
      predicted_densities:
        path: output_data/predictions
        transform:
          - .sum: [ !dag_prev , i ]
          - np.linspace: [ !dag_tag lower_bin, !dag_tag upper_bin, !dag_tag n_bins ]
          - hist_ndim: !dag_node -2
            kwargs:
              bins: !dag_prev
              exclude_dim: [ 'time' ]
      probabilities:
        path: output_data/Loss
        transform:
          - .sel: [ !dag_prev , { kind: Data loss } ]
          - mul: [!dag_prev , -1]
          - np.exp: [!dag_prev ]
          - .sum: [ !dag_node -1 ]
          - div: [ !dag_node -2, !dag_node -1 ]
  transform:
    - .min: [!dag_tag rank, vertex_idx]
    - .mean: [!dag_node -1, seed]
    - .data: [!dag_node -1]
    - div: [!dag_node -1, 19]
      tag: min_rank
    - marginal_of_density: [!dag_tag predicted_densities, !dag_tag probabilities]
      kwargs:
        error: Hellinger
        exclude_dim: [ training_set_size, seed ]
        sample_dim: time
      file_cache: { read: true, write: true }
      tag: marginals
    - getitem: [!dag_node -1, err]
    - .sum: [!dag_node -1, bin_center]
      tag: Hellinger_error
    - .rename:
      - !dag_node -1
      - {training_set_size: min_rank}
    - .assign_coords:
      - !dag_node -1
      - {min_rank: !dag_tag min_rank}
    - .isel: [ !dag_prev , { min_rank: 0 } ]
    - div: [ !dag_node -2, !dag_prev ]
      tag: errors
    - .mean: [!dag_node -1, seed]
      tag: mean_error
    - .std: [!dag_tag errors, seed]
      tag: std_error
    - xr.Dataset:
      - {y: !dag_tag mean_error, yerr: !dag_tag std_error}
      tag: data
  x: min_rank
  y: y
  yerr: yerr
  style:
    figure.figsize: [*third_width, *third_width]
  helpers:
    set_labels:
      x: $\mathfrak{c}/(N-1)$
      y: $d_\mathrm{H} / d_\mathrm{H}(\mathfrak{c}=0.21(N-1))$
    set_title:
      title: ''

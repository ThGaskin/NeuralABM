# ======================================================================================================================
#  ╦  ╦╔═╗╦═╗╦╔═╗╔╗ ╦  ╔═╗╔═╗
#  ╚╗╔╝╠═╣╠╦╝║╠═╣╠╩╗║  ║╣ ╚═╗
#   ╚╝ ╩ ╩╩╚═╩╩ ╩╚═╝╩═╝╚═╝╚═╝
# ======================================================================================================================

.variables:
  colors: &colors
    yellow:         &yellow           '#F5DDA9'
    darkblue:       &darkblue         '#2F7194'
    red:            &red              '#ec7070'
    skyblue:        &skyblue          '#97c3d0'
    darkgreen:      &darkgreen        '#48675A'
    lightbrown:     &lightbrown       '#C6BFA2'
    orange:         &orange           '#EC9F7E'
    lightgreen:     &lightgreen       '#AFD8BC'
    grey:           &grey             '#3D4244'
    pink:           &pink             '#F8A6A6'
    purple:         &purple           'purple'

  page_widths:
    full_width:     &full_width       7.00787402
    half_width:     &half_width       !expr 7.00787402 / 2
    third_width:    &third_width      !expr 7.00787402 / 3
    quarter_width:  &quarter_width    !expr 7.00787402 / 4
    fifth_width:    &fifth_width      !expr 7.00787402 / 5

  true_values:
    k_S:            &k_S              0.192
    k_E_0:          &k_E_0            1.9
    k_E_1:          &k_E_1            0.4
    k_E_2:          &k_E_2            2.5
    k_E_3:          &k_E_3            0.2
    k_E_4:          &k_E_4            1.8
    k_I:            &k_I              0.1
    k_R:            &k_R              0.6
    k_SY_0:         &k_SY_0           0.35
    k_SY_1:         &k_SY_1           0.4
    k_SY_2:         &k_SY_2           0.45
    k_H:            &k_H              0.3
    k_C:            &k_C              0.2
    k_D:            &k_D              0.3
    k_CT:           &k_CT             1.2

# ======================================================================================================================
#  ╔═╗╦  ╔═╗╔╦╗╔═╗
#  ╠═╝║  ║ ║ ║ ╚═╗
#  ╩  ╩═╝╚═╝ ╩ ╚═╝
# ======================================================================================================================
# Plot the true data
true_data:
  based_on:
    - .creator.universe
    - .plot.facet_grid.line
  universes:
    seed: [0]
  select:
    data:
      path: true_counts
      transform:
        - .sel: [!dag_prev , {kind: ['infected', 'symptomatic', 'hospitalized', 'critical']}]
        - .squeeze_with_drop: [!dag_prev ]
  x: time
  hue: kind
  add_legend: true
  linewidth: 1.5
  figsize: [ *half_width, *third_width ]
  helpers:
    set_labels:
      y: ' '
    set_scales:
      y: ~
    set_legend:
      title: ~
      custom_labels: ['I', 'S', 'H', 'C']
      ncol: 4
      bbox_to_anchor: [0, 1, 1, 0.1]
    set_hv_lines:
      vlines:
        - pos: 180
          color: *red
          linestyle: dotted
        - pos: 400
          color: *red
          linestyle: dotted
    call:
      functions:
        - function: [matplotlib.pyplot, axvspan]
          color: *pink
          alpha: 0.2
          zorder: -1
          xmin: 60
          xmax: 150
          lw: 0
        - function: [ matplotlib.pyplot, axvspan ]
          color: *pink
          alpha: 0.2
          zorder: -1
          xmin: 360
          xmax: 420
          lw: 0


densities_from_marginals:
  based_on: densities_from_marginals
  dag_options:
    define:
      num_samples: 1000

densities_from_joint:
  based_on: densities_from_joint
  dag_options:
    define:
      step_size: !slice [~, ~, 50]

# Illustrate the time dependent parameters
time_dependent_parameters:
  based_on:
    - .creator.multiverse
    - .plot.facet_grid.line
  select_and_combine:
    fields:
      cfg:
        path: ../../cfg
        transform:
          - recursive_getitem: [ !dag_prev , ['SEIRD+', 'Data'] ]
        subspace:
          seed: [ 0 ]
  transform:
    - .data: [ !dag_tag cfg ]
    - getitem: [ !dag_prev , 0 ]
    - SEIRD+_time_dependent_parameters: [!dag_prev ]
      tag: data
  x: time
  hue: parameter
  figsize: [*half_width, *third_width]
  helpers:
    call:
      functions:
        - function: [ matplotlib.pyplot, axvspan ]
          color: *pink
          alpha: 0.2
          zorder: -1
          xmin: 60
          xmax: 150
          lw: 0
        - function: [ matplotlib.pyplot, axvspan ]
          color: *pink
          alpha: 0.2
          zorder: -1
          xmin: 360
          xmax: 420
          lw: 0
    set_legend:
      title: ~
      custom_labels: ['$k_E$', '$k_{SY}$']
    set_hv_lines:
      vlines:
        - pos: 180
          color: *red
          linestyle: dotted
        - pos: 400
          color: *red
          linestyle: dotted


# Loss for each seed
loss:
  based_on:
    - .creator.multiverse
    - .plot.facet_grid.line
  select_and_combine:
    fields:
      data: loss
  hue: seed
  x: time
  alpha: 0.5
  style:
    figure.figsize: [ *full_width, *half_width ]
  helpers:
    set_legend:
      use_legend: False
    set_scales:
      y: log

# Marginals of the parameters
marginals: !pspace
  based_on: marginals_mv
  dag_options:
    define:
      parameter_idx: !sweep
        default: 0
        range: [15]
  style:
    figure.figsize: [ *third_width, *quarter_width ]

# Predicted parameters
predictions:
  based_on: predictions_mv
  col_wrap: 3
  add_legend: False
  lw: 1
  alpha: 0.5
  helpers:
    setup_figure:
      ncols: 3
      nrows: 5
    axis_specific:
      k_S:
        axis: [ 0, 0 ]
        set_hv_lines:
          hlines:
            - pos: *k_S
              color: *red
              linestyle: dotted
      k_E_0:
        axis: [ 1,0 ]
        set_hv_lines:
          hlines:
            - pos: *k_E_0
              color: *red
              linestyle: dotted
      k_E_1:
        axis: [ 2,0 ]
        set_hv_lines:
          hlines:
            - pos: *k_E_1
              color: *red
              linestyle: dotted
      k_E_2:
        axis: [ 0 , 1 ]
        set_hv_lines:
          hlines:
            - pos: *k_E_2
              color: *red
              linestyle: dotted
      k_E_3:
        axis: [ 1, 1 ]
        set_hv_lines:
          hlines:
            - pos: *k_E_3
              color: *red
              linestyle: dotted
      k_E_4:
        axis: [ 2, 1 ]
        set_hv_lines:
          hlines:
            - pos: *k_E_4
              color: *red
              linestyle: dotted
      k_I:
        axis: [ 0, 2]
        set_hv_lines:
          hlines:
            - pos: *k_I
              color: *red
              linestyle: dotted
      k_R:
        axis: [ 1, 2 ]
        set_hv_lines:
          hlines:
            - pos: *k_R
              color: *red
              linestyle: dotted
      k_SY_0:
        axis: [ 2, 2 ]
        set_hv_lines:
          hlines:
            - pos: *k_SY_0
              color: *red
              linestyle: dotted
      k_SY_1:
        axis: [ 0, 3 ]
        set_hv_lines:
          hlines:
            - pos: *k_SY_1
              color: *red
              linestyle: dotted
      k_SY_2:
        axis: [ 1, 3 ]
        set_hv_lines:
          hlines:
            - pos: *k_SY_2
              color: *red
              linestyle: dotted
      k_H:
        axis: [ 2, 3 ]
        set_hv_lines:
          hlines:
            - pos: *k_H
              color: *red
              linestyle: dotted
      k_C:
        axis: [ 0, 4 ]
        set_hv_lines:
          hlines:
            - pos: *k_C
              color: *red
              linestyle: dotted
      k_D:
        axis: [ 1, 4 ]
        set_hv_lines:
          hlines:
            - pos: *k_D
              color: *red
              linestyle: dotted
      k_CT:
        axis: [ 2, 4 ]
        set_hv_lines:
          hlines:
            - pos: *k_CT
              color: *red
              linestyle: dotted
